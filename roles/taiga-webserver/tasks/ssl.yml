---
- name: set SSL common name
  set_fact:
    _taiga_webserver_ssl_common_name: "{{ taiga_frontend_host or ansible_fqdn }}"
  tags:
    - always

- name: set SSL related paths
  set_fact:
    _taiga_webserver_ssl_certificate_path: "{{ taiga_user_home }}/{{ _taiga_webserver_ssl_common_name }}.pem"
    _taiga_webserver_ssl_key_path: "{{ taiga_user_home }}/{{ _taiga_webserver_ssl_common_name }}.key"
    _taiga_webserver_ssl_csr_path: "{{ taiga_user_home }}/{{ _taiga_webserver_ssl_common_name }}.csr"
    _taiga_webserver_ssl_dhparam_path: "{{ taiga_user_home }}/dhparam.pem"
  tags:
    - always

- name: determine whether we need a self-signed certificate
  set_fact:
    _taiga_webserver_ssl_certificate_selfsign: "{{ (taiga_webserver_ssl_key is undefined) and (ansible_version | version_compare('2.4', '>=')) }}"
  tags:
    - always

- name: create DH params
  become: true
  become_user: taiga
  command: "openssl dhparam -out {{ _taiga_webserver_ssl_dhparam_path }} {{ taiga_webserver_ssl_dhparam_bits }}"
  args:
    creates: "{{ _taiga_webserver_ssl_dhparam_path }}"
  tags:
    - config
    - front-config

- include: "ssl-{{ 'selfsign' if _taiga_webserver_ssl_certificate_selfsign | bool else 'signed'}}.yml"
